{% extends "base.html" %}

{% block title %}Scan Results{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h2>Scan Results</h2>
        <p class="lead">Target: {{ scan.target_url }}</p>
        <p>Scan completed on {{ scan.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Overall Risk Score</h5>
                <div class="display-4 text-{{ 'danger' if scan.risk_score > 7 else 'warning' if scan.risk_score > 4 else 'success' }}">
                    {{ "%.1f"|format(scan.risk_score or 0) }}/10
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Vulnerability Distribution</h5>
                <canvas id="vulnerabilityChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Detailed Findings</h5>
                
                <div class="mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active" data-filter="all">All</button>
                        <button type="button" class="btn btn-outline-danger" data-filter="Critical">Critical</button>
                        <button type="button" class="btn btn-outline-warning" data-filter="High">High</button>
                        <button type="button" class="btn btn-outline-info" data-filter="Medium">Medium</button>
                        <button type="button" class="btn btn-outline-success" data-filter="Low">Low</button>
                    </div>
                </div>

                <div class="findings-list">
                    {% for finding in scan.findings|sort(attribute='cvss_score', reverse=true) %}
                    <div class="finding-item mb-4" data-severity="{{ finding.severity }}">
                        <div class="card">
                            <div class="card-header bg-{{ 'danger' if finding.severity == 'Critical' 
                                                    else 'warning' if finding.severity == 'High'
                                                    else 'info' if finding.severity == 'Medium'
                                                    else 'success' }}">
                                <h5 class="card-title mb-0 text-white">
                                    {{ finding.vulnerability_type }}
                                    <span class="float-end">CVSS: {{ "%.1f"|format(finding.cvss_score) }}</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <h6>Description</h6>
                                <p>{{ finding.description }}</p>
                                
                                <h6>Evidence</h6>
                                <pre class="bg-light p-3 rounded"><code>{{ finding.evidence }}</code></pre>
                                
                                <h6>Mitigation Steps</h6>
                                <div class="alert alert-info">
                                    {{ finding.mitigation|replace('\n', '<br>')|safe }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Setup vulnerability distribution chart
    const findings = {{ scan.findings|tojson }};
    const severityCounts = {
        'Critical': findings.filter(f => f.severity === 'Critical').length,
        'High': findings.filter(f => f.severity === 'High').length,
        'Medium': findings.filter(f => f.severity === 'Medium').length,
        'Low': findings.filter(f => f.severity === 'Low').length
    };
    
    const ctx = document.getElementById('vulnerabilityChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(severityCounts),
            datasets: [{
                data: Object.values(severityCounts),
                backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#28a745']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    // Setup finding filters
    document.querySelectorAll('[data-filter]').forEach(button => {
        button.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            document.querySelectorAll('.finding-item').forEach(item => {
                if (filter === 'all' || item.dataset.severity === filter) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });
});
</script>
{% endblock %}